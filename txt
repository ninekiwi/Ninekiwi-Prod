// ---------------- State ----------------
let uploadedPhotos = []; // {name,data,includeInSummary:boolean,caption:string}
let isDrawing = false, signatureData = null, currentSignatureMethod = 'draw';

const FLEX_FIELDS = [
  'weatherConditions','safetyCompliance','safetySignage',
  'equipmentCondition','workmanshipQuality','siteHousekeeping',
  'qualityRating','communicationRating'
];

// ---------------- Init ----------------
document.addEventListener('DOMContentLoaded', () => {
  const now = new Date();
  const dateEl = document.getElementById('inspectionDate');
  const sigEl  = document.getElementById('signatureDateTime');
  if (dateEl) dateEl.value = now.toISOString().split('T')[0];
  if (sigEl)  sigEl.value  = now.toISOString().slice(0,16);

  initSignaturePad();
  setupFlexibleControls();
  // Ensure any pre-filled values reflect on star UI
  refreshAllStarsFromHidden();
  fetchWeatherData();
  updateProgress();
});

// ---------------- Star setters ----------------
function setWeatherRating(r){ setStar('weatherConditions', r) }
function setSafetyRating(r){ setStar('safetyCompliance', r) }
function setSafetySignageRating(r){ setStar('safetySignage', r) }
function setEquipmentRating(r){ setStar('equipmentCondition', r) }
function setWorkmanshipRating(r){ setStar('workmanshipQuality', r) }
function setHousekeepingRating(r){ setStar('siteHousekeeping', r) }
function setOverallRating(r){ setStar('qualityRating', r) }
function setCommunicationRating(r){ setStar('communicationRating', r) }

function setStar(fieldId, rating) {
  const hidden = document.getElementById(fieldId);
  if (!hidden) return;
  hidden.value = rating;
  hidden.dataset.mode = 'stars';
  const container = hidden.parentNode; // .star-rating
  container.dataset.mode = 'stars';
  updateStarDisplay(container, rating);

  // clear yes/no option when stars chosen
  document.querySelectorAll(`input[name="${fieldId}_yesno"]`).forEach(r => r.checked = false);
  updateProgress();
}

function updateStarDisplay(container, rating) {
  const n = parseInt(rating,10) || 0;
  const stars = container.querySelectorAll('.star');
  stars.forEach((s,i)=>{
    if (i < n){
      s.classList.add('active');
      s.setAttribute('aria-checked','true');
    } else {
      s.classList.remove('active');
      s.setAttribute('aria-checked','false');
    }
  });
}

// Keyboard access for stars (buttons inside .star-row)
function attachStarKeyboard(container, fieldId){
  const hidden = document.getElementById(fieldId);
  const stars = Array.from(container.querySelectorAll('.star'));
  stars.forEach((star, idx)=>{
    star.addEventListener('keydown', (e)=>{
      const cur = parseInt(hidden.value||'0',10) || 0;
      if(/^[1-5]$/.test(e.key)){ setStar(fieldId, parseInt(e.key,10)); e.preventDefault(); return; }
      if(e.key === 'ArrowRight' || e.key === 'ArrowUp'){ setStar(fieldId, Math.min(5, cur + 1)); e.preventDefault(); return; }
      if(e.key === 'ArrowLeft' || e.key === 'ArrowDown'){ setStar(fieldId, Math.max(1, (cur || 1) - 1)); e.preventDefault(); return; }
      if(e.key === 'Home'){ setStar(fieldId, 1); e.preventDefault(); return; }
      if(e.key === 'End'){  setStar(fieldId, 5); e.preventDefault(); return; }
      if(e.key === ' ' || e.key === 'Enter'){ setStar(fieldId, idx + 1); e.preventDefault(); }
    });
  });
}

// If fields had values (e.g., restored), reflect them in star UI
function refreshAllStarsFromHidden(){
  FLEX_FIELDS.forEach(id=>{
    const hidden = document.getElementById(id);
    if(!hidden) return;
    const container = hidden.parentNode;
    updateStarDisplay(container, hidden.value || 0);
  });
}

// ---------------- Weather UI ----------------
function updateWeatherDisplay(){
  const tEl = document.getElementById('temperature');
  const hEl = document.getElementById('humidity');
  const wsEl = document.getElementById('windSpeed');
  const dEl = document.getElementById('weatherDescription');
  if(!tEl || !hEl || !wsEl || !dEl) return;

  const t = tEl.value;
  const h = hEl.value;
  const ws = wsEl.value;
  const d = dEl.value;

  const feels = (t!=='' && h!=='') ? Math.round(parseInt(t,10) - (100-parseInt(h,10))/25) : '';
  const tempDisp = document.getElementById('weatherTemp');
  const humDisp  = document.getElementById('humidityDisplay');
  const windDisp = document.getElementById('windDisplay');
  const feelsDisp= document.getElementById('feelsLikeDisplay');
  const weatherDisp = document.getElementById('weatherDisplay');
  const weatherIcon = document.getElementById('weatherIcon');

  if(tempDisp) tempDisp.textContent = t?`${t}¬∞C`:'--¬∞C';
  if(humDisp)  humDisp.textContent  = h?`${h}%`:'--%';
  if(windDisp) windDisp.textContent = ws?`${ws} km/h`:'-- km/h';
  if(feelsDisp) feelsDisp.textContent= (feels!==''?`${feels}¬∞C`:'--¬∞C');

  const iconMap={Sunny:'‚òÄÔ∏è','Partly Cloudy':'‚õÖ',Cloudy:'‚òÅÔ∏è',Overcast:'üå´Ô∏è','Light Rain':'üå¶Ô∏è','Heavy Rain':'üåßÔ∏è',Foggy:'üå´Ô∏è',Windy:'üí®',Storm:'‚õàÔ∏è'};
  if (weatherDisp && weatherIcon){
    if (d){
      weatherDisp.textContent=d;
      weatherIcon.textContent=iconMap[d]||'üå§Ô∏è';
    }else{
      weatherDisp.textContent='Select weather';
      weatherIcon.textContent='üå§Ô∏è';
    }
  }
}
async function fetchWeatherData(){
  // Simulated; replace with API as needed
  const w = {
    temperature: Math.round(Math.random()*30+5),
    humidity: Math.round(Math.random()*50+30),
    windSpeed: Math.round(Math.random()*20+5),
    description: ['Sunny','Partly Cloudy','Cloudy','Light Rain','Overcast'][Math.floor(Math.random()*5)]
  };
  ['temperature','humidity','windSpeed'].forEach(k=>{
    const el = document.getElementById(k);
    if(el) el.value = w[k];
  });
  const wd = document.getElementById('weatherDescription');
  if(wd) wd.value = w.description;
  updateWeatherDisplay(); updateProgress();
}

// ---------------- Signature (touch-friendly) ----------------
function initSignaturePad(){
  const canvas = document.getElementById('signaturePad'); if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const pos = e => {
    const r=canvas.getBoundingClientRect();
    const x=(e.clientX ?? e.touches?.[0]?.clientX ?? 0)-r.left;
    const y=(e.clientY ?? e.touches?.[0]?.clientY ?? 0)-r.top;
    return {x,y};
  };
  const start = e => { isDrawing = true; draw(e); };
  const draw = e => {
    if(!isDrawing) return;
    const p = pos(e);
    ctx.lineWidth=2; ctx.lineCap='round'; ctx.strokeStyle='#1A202C';
    ctx.lineTo(p.x,p.y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(p.x,p.y);
  };
  const stop = () => { if(isDrawing){ isDrawing=false; ctx.beginPath(); } };
  canvas.addEventListener('mousedown',start);
  canvas.addEventListener('mousemove',draw);
  canvas.addEventListener('mouseup',stop);
  canvas.addEventListener('mouseleave',stop);
  canvas.addEventListener('touchstart',start,{passive:true});
  canvas.addEventListener('touchmove',draw,{passive:true});
  canvas.addEventListener('touchend',stop);
}
function clearSignature(){ const c=document.getElementById('signaturePad'); if(!c) return; c.getContext('2d').clearRect(0,0,c.width,c.height); signatureData=null; }
function saveSignature(){ const c=document.getElementById('signaturePad'); if(!c) return; signatureData=c.toDataURL(); alert('Signature saved!'); }
function showSignatureMethod(method){
  currentSignatureMethod=method;
  const draw=document.getElementById('drawSignatureSection'), up=document.getElementById('uploadSignatureSection');
  const drawBtn=document.getElementById('drawSignatureBtn'), upBtn=document.getElementById('uploadSignatureBtn');
  if(!draw || !up || !drawBtn || !upBtn) return;
  if(method==='draw'){
    draw.style.display='block'; up.style.display='none';
    drawBtn.classList.remove('bg-gray-500','hover:bg-gray-600'); drawBtn.classList.add('bg-kiwi-green','hover:bg-kiwi-dark');
    upBtn.classList.remove('bg-kiwi-green','hover:bg-kiwi-dark'); upBtn.classList.add('bg-gray-500','hover:bg-gray-600');
  } else {
    draw.style.display='none'; up.style.display='block';
    upBtn.classList.remove('bg-gray-500','hover:bg-gray-600'); upBtn.classList.add('bg-kiwi-green','hover:bg-kiwi-dark');
    drawBtn.classList.remove('bg-kiwi-green','hover:bg-kiwi-dark'); drawBtn.classList.add('bg-gray-500','hover:bg-gray-600');
  }
}
function handleSignatureImageUpload(){
  const file=document.getElementById('signatureImageUpload')?.files?.[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    signatureData=e.target.result;
    const cont = document.getElementById('uploadedSignaturePreview');
    if(cont){
      cont.innerHTML=`<img src="${signatureData}" class="max-h-20 border rounded mt-2" alt="Signature"><p class="text-xs text-green-600 mt-1">Uploaded.</p>`;
    }
  };
  reader.readAsDataURL(file);
}

// ---------------- Photos ----------------
// Helper: downscale and compress images to keep PDFs light (iOS/Android friendly)
function resizeDataUrl(dataUrl, maxDim=1600, quality=0.85){
  return new Promise(resolve=>{
    const img = new Image();
    img.onload = ()=>{
      let {width:w, height:h} = img;
      const scale = Math.min(maxDim/w, maxDim/h, 1);
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(w*scale);
      canvas.height = Math.round(h*scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img,0,0,canvas.width,canvas.height);
      // JPEG keeps file small; good for photos
      resolve(canvas.toDataURL('image/jpeg', quality));
    };
    img.src = dataUrl;
  });
}

async function handlePhotoUpload(){
  const input = document.getElementById('photoUpload');
  if(!input) return;
  const files = Array.from(input.files || []);
  if (!files.length) return;

  // read & compress in parallel
  const items = await Promise.all(files.map(file => new Promise(res=>{
    const reader=new FileReader();
    reader.onload = async e=>{
      const compressed = await resizeDataUrl(e.target.result);
      res({name:file.name,data:compressed,includeInSummary:false,caption:''});
    };
    reader.readAsDataURL(file);
  })));

  uploadedPhotos = uploadedPhotos.concat(items);
  displayPhotoPreview();
}

function setPhotoCaption(i, txt){
  if (uploadedPhotos[i]) {
    uploadedPhotos[i].caption = txt;
    generateAutoSummary(); // reflect in summary instantly
  }
}
function toggleSummary(i,checked){ if(uploadedPhotos[i]){ uploadedPhotos[i].includeInSummary = !!checked; generateAutoSummary(); } }
function removePhoto(i){ uploadedPhotos.splice(i,1); displayPhotoPreview(); }

function displayPhotoPreview(){
  const el=document.getElementById('photoPreview'); if(!el) return;
  el.innerHTML='';
  uploadedPhotos.forEach((p,i)=>{
    const card=document.createElement('div');
    card.className='relative border rounded-lg overflow-hidden bg-white';
    const safeCaption = (p.caption||'').replace(/"/g,'&quot;');
    card.innerHTML = `
      <div class="relative">
        <img src="${p.data}" alt="${safeCaption || 'photo'}" class="w-full h-40 object-cover">
        <div class="absolute inset-x-0 top-0 p-2 flex items-center justify-between pointer-events-none">
          <span class="px-2 py-0.5 text-[11px] bg-black/60 text-white rounded">#${i+1}</span>
        </div>
        <div class="absolute inset-x-0 bottom-0 bg-black/50 text-white text-xs p-2 flex items-center justify-between">
          <label class="flex items-center gap-1"><input type="checkbox" ${p.includeInSummary?'checked':''} onchange="toggleSummary(${i},this.checked)"><span>Summary</span></label>
          <button onclick="removePhoto(${i})" class="px-2 py-0.5 bg-red-500 rounded">Remove</button>
        </div>
      </div>
      <div class="p-2 border-t">
        <input type="text" class="w-full px-2 py-1 border rounded text-sm" placeholder="Write image caption‚Ä¶" value="${safeCaption}" oninput="setPhotoCaption(${i}, this.value)">
      </div>`;
    el.appendChild(card);
  });
  generateAutoSummary();
}
// If none ticked, include all in summary so it mirrors the report
function getSummaryPhotos(){
  const selected = uploadedPhotos.filter(p=>p.includeInSummary);
  return selected.length ? selected : uploadedPhotos;
}

// ---------------- Flexible controls: ‚≠ê or Yes/No ----------------
function setupFlexibleControls(){
  FLEX_FIELDS.forEach(id=>{
    const hidden=document.getElementById(id); if(!hidden) return;
    const container=hidden.parentNode; // .star-rating
    container.classList.add('flex','flex-col','gap-2');

    // Toggle UI
    const toggle=document.createElement('div'); toggle.className='flex gap-4 text-xs text-kiwi-gray';
    toggle.innerHTML=`
      <label class="flex items-center gap-1"><input type="radio" name="mode_${id}" value="stars" checked>‚≠ê Rate</label>
      <label class="flex items-center gap-1"><input type="radio" name="mode_${id}" value="yesno">Yes/No</label>`;

    // Yes/No row
    const yesno=document.createElement('div'); yesno.className='yesno hidden';
    yesno.innerHTML=`
      <label class="flex items-center gap-1"><input type="radio" name="${id}_yesno" value="Yes">Yes</label>
      <label class="flex items-center gap-1"><input type="radio" name="${id}_yesno" value="No">No</label>`;

    // Insert elements
    container.insertBefore(toggle, container.firstChild);
    container.appendChild(yesno);
    hidden.dataset.mode='stars';
    container.dataset.mode='stars';

    // Keyboard support for stars
    attachStarKeyboard(container, id);

    toggle.addEventListener('change',e=>{
      if(e.target.name!==`mode_${id}`) return;
      if(e.target.value==='yesno'){
        yesno.classList.remove('hidden');
        container.dataset.mode='yesno';
        hidden.dataset.mode='yesno';
        hidden.value='';
        // clear stars + aria
        updateStarDisplay(container, 0);
      } else {
        yesno.classList.add('hidden');
        container.dataset.mode='stars';
        hidden.dataset.mode='stars';
        hidden.value='';
        document.querySelectorAll(`input[name="${id}_yesno"]`).forEach(r=>r.checked=false);
      }
      updateProgress();
    });
    yesno.addEventListener('change',e=>{
      if(e.target.name!==`${id}_yesno`) return;
      hidden.value=e.target.value;
      updateStarDisplay(container,0);
      updateProgress();
    });
  });
}

function formatFlexibleAnswer(id,val,modes){
  const mode=modes?.[id]||'stars';
  if(mode==='yesno') return val||'N/A';
  return getStarRatingText(val);
}
function toScore(val){
  if(val==='Yes') return 5;
  if(val==='No') return 1;
  const n=parseInt(val,10);
  return isNaN(n)?0:n;
}

// ---------------- Data + Preview + Progress ----------------
function gatherFormData(){
  const d={
    projectName:val('projectName'), reportId:val('reportId'), clientName:val('clientName'), contractorName:val('contractorName'),
    inspectorName:val('inspectorName'), supervisorName:val('supervisorName'), contactPhone:val('contactPhone'), contactEmail:val('contactEmail'),
    location:val('location'), inspectionDate:val('inspectionDate'),
    temperature:val('temperature'), humidity:val('humidity'), windSpeed:val('windSpeed'), weatherDescription:val('weatherDescription'),
    weatherConditions:val('weatherConditions'),
    safetyCompliance:val('safetyCompliance'), safetySignage:val('safetySignage'),
    numWorkers:val('numWorkers'), workerAttendance:radio('workerAttendance'),
    workProgress:val('workProgress'), scheduleCompliance:radio('scheduleCompliance'), materialAvailability:radio('materialAvailability'),
    equipmentCondition:val('equipmentCondition'), maintenanceStatus:radio('maintenanceStatus'),
    workmanshipQuality:val('workmanshipQuality'), specificationCompliance:radio('specificationCompliance'),
    incidentsHazards:radio('incidentsHazards'), siteHousekeeping:val('siteHousekeeping'), stakeholderVisits:radio('stakeholderVisits'),
    additionalComments:val('additionalComments'), inspectorSummary:val('inspectorSummary'), recommendations:val('recommendations'),
    qualityRating:val('qualityRating'), communicationRating:val('communicationRating'), recommendationRating:radio('recommendationRating'),
    improvementAreas:val('improvementAreas'), signatureDateTime:val('signatureDateTime'), flexibleModes:{}
  };
  FLEX_FIELDS.forEach(id=>{ const el=document.getElementById(id); if(el){ d.flexibleModes[id]=el.dataset.mode||'stars'; }});
  return d;
}
const val=id=>document.getElementById(id)?.value||'';
const radio=name=>document.querySelector(`input[name="${name}"]:checked`)?.value||'';

function updateProgress(){
  const ids=['projectName','inspectorName','location','inspectionDate',
    'temperature','humidity','windSpeed','weatherDescription','weatherConditions',
    'safetyCompliance','safetySignage','numWorkers','workerAttendance',
    'workProgress','scheduleCompliance','materialAvailability',
    'equipmentCondition','maintenanceStatus','workmanshipQuality',
    'specificationCompliance','incidentsHazards','siteHousekeeping','stakeholderVisits',
    'additionalComments','inspectorSummary','recommendations','qualityRating','communicationRating',
    'recommendationRating','improvementAreas','signatureDateTime','clientName','contractorName','supervisorName','contactPhone','contactEmail','reportId'
  ];
  let filled=0;
  ids.forEach(id=>{
    const el=document.getElementById(id);
    if(el){ if((el.value??'').toString().trim()!=='') filled++; }
    else { const r=document.querySelector(`input[name="${id}"]:checked`); if(r) filled++; }
  });
  const pct=Math.round((filled/ids.length)*100);
  const bar = document.getElementById('progressBar');
  const txt = document.getElementById('progressText');
  if(bar) bar.style.width = pct+'%';
  if(txt) txt.textContent = pct+'%';
  updatePreview();
  generateAutoSummary();
}

function getStarRatingText(n){
  const v=parseInt(n,10);
  if(v===5) return 'Excellent (5/5)';
  if(v===4) return 'Good (4/5)';
  if(v===3) return 'Average (3/5)';
  if(v===2) return 'Below Average (2/5)';
  if(v===1) return 'Poor (1/5)';
  return 'Not Rated';
}
function fmtDate(s){ return s?new Date(s).toLocaleDateString():new Date().toLocaleDateString(); }

// ---------------- Report HTML (with page-break protection) ----------------
function generateReportHTML(d){
  const A=(id)=>formatFlexibleAnswer(id,d[id],d.flexibleModes);
  const chips = `
    ${d.reportId?`<span class="pill">Report # ${d.reportId}</span>`:''}
    ${d.scheduleCompliance?`<span class="pill">Schedule: ${d.scheduleCompliance}</span>`:''}
    ${d.materialAvailability?`<span class="pill">Materials: ${d.materialAvailability}</span>`:''}
    ${d.incidentsHazards?`<span class="pill">Incidents: ${d.incidentsHazards}</span>`:''}
  `;
  return `
  <div class="bg-white p-8 rounded-lg shadow-lg">
    <!-- Header -->
    <div class="mb-6 pb-5 border-b-2 border-kiwi-green avoid-break">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-lg grid place-items-center">
            <img src="logo.png" alt="ninekiwi_logo" crossorigin="anonymous" referrerpolicy="no-referrer" class="w-12 h-12 object-contain">
          </div>
          <div>
            <h1 class="text-2xl font-bold text-kiwi-dark">NineKiwi Inspection Report</h1>
            <p class="text-xs text-kiwi-gray">Generated ${new Date().toLocaleString()}</p>
          </div>
        </div>
        <div class="text-right text-sm">${chips}</div>
      </div>
    </div>

    <!-- Project & Contact -->
    <div class="mb-6 avoid-break">
      <h2 class="text-xl font-semibold text-kiwi-dark mb-3 bg-kiwi-light p-3 rounded">Project & Contact</h2>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div><strong>Project:</strong> ${d.projectName||'N/A'}</div>
        <div><strong>Date:</strong> ${fmtDate(d.inspectionDate)}</div>
        <div><strong>Client:</strong> ${d.clientName||'N/A'}</div>
        <div><strong>Contractor:</strong> ${d.contractorName||'N/A'}</div>
        <div><strong>Inspector:</strong> ${d.inspectorName||'N/A'}</div>
        <div><strong>Supervisor:</strong> ${d.supervisorName||'N/A'}</div>
        <div><strong>Phone:</strong> ${d.contactPhone||'N/A'}</div>
        <div><strong>Email:</strong> ${d.contactEmail||'N/A'}</div>
        <div class="col-span-2"><strong>Location:</strong> ${d.location||'N/A'}</div>
      </div>
    </div>

    ${(d.temperature||d.weatherDescription)?`
    <div class="mb-6 avoid-break">
      <h2 class="text-xl font-semibold text-kiwi-dark mb-3 bg-kiwi-light p-3 rounded">Weather</h2>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div><strong>Description:</strong> ${d.weatherDescription||'N/A'}</div>
        <div><strong>Impact Rating:</strong> ${A('weatherConditions')}</div>
        <div><strong>Temp:</strong> ${d.temperature||'N/A'}¬∞C</div>
        <div><strong>Humidity:</strong> ${d.humidity||'N/A'}%</div>
        <div><strong>Wind:</strong> ${d.windSpeed||'N/A'} km/h</div>
      </div>
    </div>`:''}

    <!-- Inspection -->
    <div class="mb-6 avoid-break">
      <h2 class="text-xl font-semibold text-kiwi-dark mb-3 bg-kiwi-light p-3 rounded">Inspection</h2>
      <table class="w-full text-sm border-collapse border border-gray-300">
        <thead><tr class="bg-kiwi-light">
          <th class="border p-2 text-left">Question</th><th class="border p-2 text-left">Response</th></tr></thead>
        <tbody>
          <tr><td class="border p-2">PPE & safety protocols followed?</td><td class="border p-2">${A('safetyCompliance')}</td></tr>
          <tr><td class="border p-2">Safety signage/access control?</td><td class="border p-2">${A('safetySignage')}</td></tr>
          <tr><td class="border p-2">Workers on site</td><td class="border p-2">${d.numWorkers||'0'}</td></tr>
          <tr><td class="border p-2">Attendance & punctuality</td><td class="border p-2">${d.workerAttendance||'N/A'}</td></tr>
          <tr><td class="border p-2">Progress vs schedule</td><td class="border p-2">${d.scheduleCompliance||'N/A'}</td></tr>
          <tr><td class="border p-2">Materials availability</td><td class="border p-2">${d.materialAvailability||'N/A'}</td></tr>
          <tr><td class="border p-2">Equipment condition</td><td class="border p-2">${A('equipmentCondition')}</td></tr>
          <tr><td class="border p-2">Maintenance status</td><td class="border p-2">${d.maintenanceStatus||'N/A'}</td></tr>
          <tr><td class="border p-2">Workmanship quality</td><td class="border p-2">${A('workmanshipQuality')}</td></tr>
          <tr><td class="border p-2">Work per specifications?</td><td class="border p-2">${d.specificationCompliance||'N/A'}</td></tr>
          <tr><td class="border p-2">Incidents / hazards today?</td><td class="border p-2">${d.incidentsHazards||'N/A'}</td></tr>
          <tr><td class="border p-2">Housekeeping / cleanliness</td><td class="border p-2">${A('siteHousekeeping')}</td></tr>
          <tr><td class="border p-2">Stakeholder/inspector visits</td><td class="border p-2">${d.stakeholderVisits||'N/A'}</td></tr>
          <tr><td class="border p-2">Work progress summary</td><td class="border p-2">${d.workProgress||'N/A'}</td></tr>
          <tr><td class="border p-2">Additional comments</td><td class="border p-2">${d.additionalComments||'N/A'}</td></tr>
        </tbody>
      </table>
    </div>

    ${(d.qualityRating||d.communicationRating||d.recommendationRating||d.improvementAreas)?`
    <div class="mb-6 avoid-break">
      <h2 class="text-xl font-semibold text-kiwi-dark mb-3 bg-kiwi-light p-3 rounded">Quality Survey</h2>
      <div class="grid grid-cols-2 gap-4 text-sm">
        <div><strong>Overall Quality:</strong> ${A('qualityRating')}</div>
        <div><strong>Team Communication:</strong> ${A('communicationRating')}</div>
        <div><strong>Recommend Team:</strong> ${d.recommendationRating||'N/A'}</div>
        ${d.improvementAreas?`<div class="col-span-2"><strong>Improvement Areas:</strong> ${d.improvementAreas}</div>`:''}
      </div>
    </div>`:''}

    ${uploadedPhotos.length?`
    <div class="mb-6 avoid-break">
      <h2 class="text-xl font-semibold text-kiwi-dark mb-3 bg-kiwi-light p-3 rounded">Photo Evidence</h2>
      <div class="grid grid-cols-2 gap-6">
        ${uploadedPhotos.map(p=>`<figure class="border rounded overflow-hidden bg-white avoid-break"><img src="${p.data}" alt="${(p.caption||'photo').replace(/"/g,'&quot;')}" class="w-full h-40 object-cover"><figcaption class="text-xs p-2 text-center text-gray-600">${p.caption ? p.caption : ''}</figcaption></figure>`).join('')}
      </div>
    </div>`:''}

    ${(d.inspectorSummary||d.recommendations)?`
    <div class="mb-6 avoid-break">
      <h2 class="text-xl font-semibold text-kiwi-dark mb-3 bg-kiwi-light p-3 rounded">Summary & Recommendations</h2>
      ${d.inspectorSummary?`<div class="mb-3"><strong>Summary:</strong><br>${d.inspectorSummary}</div>`:''}
      ${d.recommendations?`<div><strong>Recommendations:</strong><br>${d.recommendations}</div>`:''}
    </div>`:''}

    ${signatureData?`
    <div class="mb-6 avoid-break">
      <h2 class="text-xl font-semibold text-kiwi-dark mb-3 bg-kiwi-light p-3 rounded">Digital Sign-off</h2>
      <div class="flex items-center gap-6">
        <div><p class="text-sm font-semibold mb-2">Inspector Signature:</p><img src="${signatureData}" class="border rounded" style="max-height:100px" alt="Signature"></div>
        <div class="text-sm">
          <p><strong>Signed By:</strong> ${d.inspectorName||'N/A'}</p>
          <p><strong>Date & Time:</strong> ${d.signatureDateTime ? new Date(d.signatureDateTime).toLocaleString() : 'N/A'}</p>
        </div>
      </div>
    </div>`:''}
  </div>`;
}

function updatePreview(){
  const d=gatherFormData();
  const preview = document.getElementById('reportPreview');
  if(!preview) return;
  if(!d.projectName){
    preview.innerHTML = `
      <div class="text-center text-gray-500">
        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6"/></svg>
        <p class="text-lg font-medium">Report Preview</p>
        <p class="text-sm mt-2">Fill the form to see your report</p>
      </div>`;
    return;
  }
  preview.innerHTML = generateReportHTML(d);
}

// ---------------- Auto Summary (with images + captions) ----------------
function generateAutoSummary(){
  const d=gatherFormData();
  const out = document.getElementById('autoSummary');
  if(!out) return;

  if(!d.projectName){
    out.innerHTML = '<p class="text-kiwi-gray italic">Summary is generated from your inputs (images supported).</p>';
    return;
  }

  const safety=toScore(d.safetyCompliance), signage=toScore(d.safetySignage), equip=toScore(d.equipmentCondition),
        workm=toScore(d.workmanshipQuality), house=toScore(d.siteHousekeeping),
        weather=toScore(d.weatherConditions), quality=toScore(d.qualityRating);

  let status='satisfactory', critical=[], good=[], recs=[];
  if (safety<=2 || signage<=2){ critical.push('Safety compliance/signage concerns'); status='requires immediate attention'; recs.push('Reinforce PPE & access controls; run toolbox talk'); }
  else if (safety>=4 && signage>=4) good.push('Strong safety culture and clear signage');

  if (workm<=2 || d.specificationCompliance==='No'){ critical.push('Quality deviations from specs'); if(status==='satisfactory') status='needs attention'; recs.push('Increase QC checks; rectify non-conformances'); }
  else if (workm>=4 && d.specificationCompliance==='Yes') good.push('High-quality workmanship aligned to specs');

  if (d.incidentsHazards==='Yes'){ critical.push('Incident(s) reported'); status='requires immediate attention'; recs.push('Conduct incident review; implement corrective actions'); }

  if (house<=2){ critical.push('Housekeeping below standard'); recs.push('Improve cleanliness and waste segregation'); }
  else if (house>=4){ good.push('Site housekeeping in good order'); }

  let weatherNote='';
  if (weather<=2){ weatherNote='Adverse weather impacted productivity.'; recs.push('Monitor forecast; adjust plan/schedule'); }
  else if (weather>=4){ weatherNote='Favorable weather supported progress.'; }

  if (quality>=4) good.push(`Overall quality trending strong (${quality}/5)`);
  else if (quality>0 && quality<=2){ critical.push(`Overall quality low (${quality}/5)`); if(status==='satisfactory') status='needs attention'; }

  const color={ 'satisfactory':'text-green-600','needs attention':'text-yellow-600','requires immediate attention':'text-red-600' }[status]||'text-kiwi-gray';

  const sPhotos=getSummaryPhotos();
  const photoGrid = sPhotos.length ? `
    <div class="mt-2">
      <div class="text-sm font-semibold mb-1">üì∑ Summary Photos</div>
      <div class="grid grid-cols-2 gap-3">
        ${sPhotos.map(p=>`
          <figure class="border rounded overflow-hidden bg-white avoid-break">
            <img src="${p.data}" alt="${(p.caption||'photo').replace(/"/g,'&quot;')}" class="w-full h-24 object-cover">
            <figcaption class="text-[11px] text-center p-1 text-gray-600">${p.caption ? p.caption : ''}</figcaption>
          </figure>
        `).join('')}
      </div>
    </div>` : '';

  const infoRow = `
    <div class="text-[13px] text-kiwi-gray mt-1">
      <b>Project:</b> ${d.projectName} &nbsp;|&nbsp;
      <b>Location:</b> ${d.location||'N/A'} &nbsp;|&nbsp;
      <b>Date:</b> ${fmtDate(d.inspectionDate)} &nbsp;|&nbsp;
      <b>Workers:</b> ${d.numWorkers||'0'}
    </div>`;

  const weatherRow = (d.temperature || d.weatherDescription) ? `
    <div class="text-[13px] text-kiwi-gray">
      <b>Weather:</b> ${d.weatherDescription || 'N/A'} &nbsp;|&nbsp;
      <b>Rating:</b> ${d.flexibleModes.weatherConditions==='yesno' ? (d.weatherConditions||'N/A') : (weather?weather+'/5':'Not Rated')} &nbsp;|&nbsp;
      <b>Temp:</b> ${d.temperature || 'N/A'}¬∞C &nbsp;|&nbsp;
      <b>Humidity:</b> ${d.humidity || 'N/A'}% &nbsp;|&nbsp;
      <b>Wind:</b> ${d.windSpeed || 'N/A'} km/h
    </div>` : '';

  const list = (title, arr, cls) => arr.length ? `
    <div class="border-l-4 ${cls==='red'?'border-red-400 bg-red-50':cls==='green'?'border-green-400 bg-green-50':'border-blue-400 bg-blue-50'} p-3 rounded">
      <div class="font-semibold ${cls==='red'?'text-red-800':cls==='green'?'text-green-800':'text-blue-800'}">${title}</div>
      <ul class="${cls==='red'?'text-red-700':cls==='green'?'text-green-700':'text-blue-700'} text-sm mt-1 list-disc list-inside">
        ${arr.map(i=>`<li>${i}</li>`).join('')}
      </ul>
    </div>` : '';

  const bullets = d.inspectorSummary ? `
    <div class="bg-gray-50 border border-gray-200 rounded p-3">
      <div class="font-semibold text-gray-800 mb-1">üìù Inspector Notes</div>
      <div class="text-sm text-gray-700 whitespace-pre-line">${d.inspectorSummary}</div>
    </div>` : '';

  const workRow = d.workProgress ? `
    <div class="bg-gray-50 border border-gray-200 rounded p-3">
      <div class="font-semibold text-gray-800 mb-1">üìå Work Progress</div>
      <div class="text-sm text-gray-700 whitespace-pre-line">${d.workProgress}</div>
    </div>` : '';

  const recsRow = list('üí° Recommendations', recs, 'blue');
  const statusBlock = `<div class="font-semibold ${color} text-lg">üìã Project Status: ${status[0].toUpperCase()+status.slice(1)}</div>`;
  const critRow = list('‚ö†Ô∏è Critical Issues', critical, 'red');
  const posRow = list('‚úÖ Positive Highlights', good, 'green');
  const weatherNoteRow = weatherNote ? `<div class="text-sm text-kiwi-gray italic">üå§Ô∏è ${weatherNote}</div>` : '';

  out.innerHTML = `
    <div class="space-y-3">
      ${statusBlock}
      ${infoRow}
      ${weatherRow}
      ${critRow}
      ${posRow}
      ${bullets}
      ${workRow}
      ${recsRow}
      ${weatherNoteRow}
      ${photoGrid}
    </div>`;
}

// ---------------- Export helpers (fix blank PDF) ----------------
function ensureHtml2Pdf() {
  if (typeof window.html2pdf !== 'function') {
    alert('Export library not loaded. Keep only html2pdf.bundle.min.js (remove separate html2canvas/jsPDF).');
    throw new Error('html2pdf not loaded');
  }
}

// Wait two frames so the browser fully lays out appended nodes
const nextFrame = () => new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

// Ensure <img> inside the container are fully loaded before rasterizing
async function waitForImages(root) {
  const imgs = Array.from(root.querySelectorAll('img'));
  if (!imgs.length) return;
  await Promise.all(imgs.map(img => (
    img.complete ? Promise.resolve() : new Promise(res => {
      img.onload = res; img.onerror = res;
    })
  )));
}

// Export via html2pdf (respects CSS breaks)
function html2pdfExport(el, filename){
  ensureHtml2Pdf();
  const opt = {
    margin: [10,10,10,10],
    filename,
    image: { type:'jpeg', quality:0.95 },
    html2canvas: { scale: 2, useCORS: true, backgroundColor:'#ffffff', letterRendering:true },
    jsPDF: { unit:'mm', format:'a4', orientation:'portrait' },
    pagebreak: { mode:['css','legacy'], avoid: ['.avoid-break'] }
  };
  return window.html2pdf().set(opt).from(el).save();
}

async function generateReport(){
  const d=gatherFormData();
  if(!d.projectName){ alert('Please enter Project Name.'); return; }

  // Build a *visible* temp container (do not hide with display:none)
  const temp=document.createElement('div');
  temp.style.width='210mm';
  temp.style.padding='16mm';
  temp.style.background='#ffffff';
  temp.style.fontFamily='Times New Roman, serif';
  temp.innerHTML = generateReportHTML(d);
  document.body.appendChild(temp);

  try{
    await nextFrame();           // allow layout
    await waitForImages(temp);   // wait for images (logo + photos)
    await html2pdfExport(temp, `ninekiwi_report_${d.projectName.replace(/\s+/g,'_')}_${new Date().toISOString().split('T')[0]}.pdf`);
  }catch(e){ console.error(e); alert('PDF generation failed.'); }
  finally{ document.body.removeChild(temp); }
}

async function generateSummaryPDF(){
  const d=gatherFormData();
  if(!d.projectName){ alert('Please enter Project Name.'); return; }
  const box=document.createElement('div');
  box.style.width='210mm'; box.style.padding='16mm'; box.style.background='#ffffff'; box.style.fontFamily='Times New Roman, serif';
  box.innerHTML = `
    <div style="text-align:center;margin-bottom:10px;">
      <div style="display:inline-flex;align-items:center;gap:8px;">
        <div style="width:36px;height:36px;background:#78C850;border-radius:8px;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700">NK</div>
        <div style="font-size:18px;font-weight:700;color:#1A202C">NineKiwi ‚Äì Inspection Summary</div>
      </div>
      <div style="font-size:12px;color:#4A5568">${new Date().toLocaleString()}</div>
    </div>
    <div style="font-size:12px;margin-bottom:8px;">
      <b>Project:</b> ${d.projectName||'N/A'} &nbsp;|&nbsp; <b>Location:</b> ${d.location||'N/A'} &nbsp;|&nbsp; <b>Date:</b> ${fmtDate(d.inspectionDate)} &nbsp;|&nbsp; <b>Workers:</b> ${d.numWorkers||'0'}
    </div>
    <hr style="border:0;border-top:1px solid #ddd;margin:10px 0 14px 0"/>
    <div class="avoid-break">${document.getElementById('autoSummary')?.innerHTML || ''}</div>
  `;
  document.body.appendChild(box);
  try{
    await nextFrame();
    await waitForImages(box);
    await html2pdfExport(box, `ninekiwi_summary_${d.projectName.replace(/\s+/g,'_')}_${new Date().toISOString().split('T')[0]}.pdf`);
  }catch(e){ console.error(e); alert('Summary PDF failed.'); }
  finally{ document.body.removeChild(box); }
}

function generateSummaryWord(){
  const d=gatherFormData();
  if(!d.projectName){ alert('Please enter Project Name.'); return; }
  const sPhotos=getSummaryPhotos();

  // Build a Word-friendly two-column table for photos
  const photosWordHTML = sPhotos.length ? `
    <h2>Summary Photos</h2>
    <table style="width:100%;border-collapse:collapse" border="0" cellspacing="0" cellpadding="6">
      ${sPhotos.reduce((rows, p, idx) => {
        const cell = `<td style="width:50%;vertical-align:top;border:1px solid #ddd">
                        <img src="${p.data}" style="max-width:100%;height:auto"><div style="font-size:9pt;color:#666">${p.caption ? p.caption : ''}</div>
                      </td>`;
        if (idx % 2 === 0) rows.push('<tr>'+cell);
        else rows[rows.length-1] += cell + '</tr>';
        return rows;
      }, []).map(r => r.endsWith('</tr>') ? r : (r + '<td style="width:50%;border:1px solid #ddd"></td></tr>')).join('')}
    </table>` : '';

  const autoSummaryHTML = document.getElementById('autoSummary')?.innerHTML || '';

  const docHTML = `
    <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
    <head><meta charset="utf-8"><title>Summary</title>
      <style>
        body{font-family:Times New Roman,serif;font-size:12pt}
        h1{font-size:18pt;margin:0 0 6pt 0}
        h2{font-size:14pt;margin:12pt 0 6pt 0}
        .kpi{margin:6pt 0 10pt 0;color:#444}
        .chip{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:2px 8px;margin-right:6px;font-size:10pt}
        .section{margin:10pt 0}
        ul{margin:4pt 0 8pt 16pt}
        img{max-width:100%;height:auto}
      </style>
    </head>
    <body>
      <h1>NineKiwi ‚Äì Inspection Summary</h1>
      <div class="kpi"><span class="chip"><b>Project:</b> ${d.projectName||'N/A'}</span>
      <span class="chip"><b>Date:</b> ${fmtDate(d.inspectionDate)}</span>
      <span class="chip"><b>Location:</b> ${d.location||'N/A'}</span>
      <span class="chip"><b>Workers:</b> ${d.numWorkers||'0'}</span></div>
      <hr>
      <div class="section">${autoSummaryHTML}</div>
      ${photosWordHTML}
    </body></html>`;
  const blob = new Blob([docHTML], { type: 'application/msword' });
  // FileSaver from CDN is required on the page
  if (typeof saveAs !== 'function') {
    alert('FileSaver not loaded. Include FileSaver.min.js for Word export.');
    return;
  }
  saveAs(blob, `ninekiwi_summary_${d.projectName.replace(/\s+/g,'_')}_${new Date().toISOString().split('T')[0]}.doc`);
}
